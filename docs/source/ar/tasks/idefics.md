# ุงูููุงู ุงููุชุนููุฉ ุจุงูุตูุฑ ุจุงุณุชุฎุฏุงู IDEFICS

[[open-in-colab]]

ูู ุญูู ูููู ูุนุงูุฌุฉ ุงูููุงู ุงููุฑุฏูุฉ ุนู ุทุฑูู ุถุจุท ููุงุฐุฌ ูุชุฎุตุตุฉุ ููุงู ููุฌ ุจุฏูู ุธูุฑ ูุคุฎุฑูุง ูุงูุชุณุจ ุดุนุจูุฉ ููู ุงุณุชุฎุฏุงู ุงูููุงุฐุฌ ุงููุจูุฑุฉ ููุฌููุนุฉ ูุชููุนุฉ ูู ุงูููุงู ุฏูู ุถุจุท ุฏููู. ุนูู ุณุจูู ุงููุซุงูุ ูููู ูููุงุฐุฌ ุงููุบุฉ ุงููุจูุฑุฉ ุงูุชุนุงูู ูุน ููุงู NLP ูุซู ุงูููุฎุต ูุงูุชุฑุฌูุฉ ูุงูุชุตููู ูุฃูุซุฑ ูู ุฐูู. ูู ูุนุฏ ูุฐุง ุงูููุฌ ููุชุตุฑ ุนูู ุทุฑููุฉ ูุงุญุฏุฉุ ูุซู ุงููุตุ ููู ูุฐุง ุงูุฏูููุ ุณููุถุญ ููู ููููู ุญู ููุงู ุงูุตูุฑ ูุงููุตูุต ุจุงุณุชุฎุฏุงู ูููุฐุฌ ูุชุนุฏุฏ ุงููุณุงุฆุท ูุจูุฑ ูุณูู IDEFICS.

[IDEFICS](../model_doc/idefics) ูู ูููุฐุฌ ููุชูุญ ุงููุตูู ููุฑุคูุฉ ูุงููุบุฉ ูุนุชูุฏ ุนูู [Flamingo](https://huggingface.co/papers/2204.14198)ุ ููู ูููุฐุฌ ูุบุฉ ุจุตุฑูุฉ ูุชุทูุฑ ุทูุฑุชู DeepMind ูู ุงูุฃุตู. ููุจู ุงููููุฐุฌ ุชุณูุณูุงุช ุนุดูุงุฆูุฉ ูู ุฅุฏุฎุงูุงุช ุงูุตูุฑ ูุงููุตูุต ูููุชุฌ ูุตูุง ูุชูุงุณููุง ูุฅุฎุฑุงุฌ. ููููู ุงูุฅุฌุงุจุฉ ุนูู ุงูุฃุณุฆูุฉ ุญูู ุงูุตูุฑุ ููุตู ุงููุญุชูู ุงููุฑุฆูุ ูุฎูู ูุตุต ูุงุฆูุฉ ุนูู ุตูุฑ ูุชุนุฏุฏุฉุ ูููู ุฌุฑุง. ูุฃุชู IDEFICS ูู ูุชุบูุฑูู - [80 ูููุงุฑ ูุนููุฉ](https://huggingface.co/HuggingFaceM4/idefics-80b) ู [9 ูููุงุฑ ูุนููุฉ](https://huggingface.co/HuggingFaceM4/idefics-9b)ุ ูููุงููุง ูุชุงุญ ุนูู Hub ๐ค. ูุจุงููุณุจุฉ ููู ูุชุบูุฑุ ููููู ุฃูุถูุง ุงูุนุซูุฑ ุนูู ุฅุตุฏุงุฑุงุช ููุนููููุฉ ูู ุงููููุฐุฌ ุงูููุนุฏููู ููุงุณุชุฎุฏุงูุงุช ุงููุญุงุฏุซูุฉ.

ูุฐุง ุงููููุฐุฌ ูุชุนุฏุฏ ุงูุงุณุชุฎุฏุงูุงุช ุจุดูู ุงุณุชุซูุงุฆู ููููู ุงุณุชุฎุฏุงูู ููุฌููุนุฉ ูุงุณุนุฉ ูู ุงูููุงู ุงููุชุนููุฉ ุจุงูุตูุฑ ูุงููุณุงุฆุท ุงููุชุนุฏุฏุฉ. ููุน ุฐููุ ูุฅู ููููุง ูููุฐุฌูุง ูุจูุฑูุง ูุนูู ุฃููุง ุชุชุทูุจ ููุงุฑุฏ ุญูุณุจุฉ ูููุงูู ุฃุณุงุณูุฉ ูุจูุฑุฉ. ุงูุฃูุฑ ูุชุฑูู ูู ูุชูุฑุฑ ูุง ุฅุฐุง ูุงู ูุฐุง ุงูููุฌ ููุงุณุจ ุญุงูุชู ุงูุงุณุชุฎุฏุงููุฉ ุจุดูู ุฃูุถู ูู ุถุจุท ุงูููุงุฐุฌ ุงููุชุฎุตุตุฉ ููู ูููุฉ ูุฑุฏูุฉ.

ูู ูุฐุง ุงูุฏูููุ ุณุชุชุนูู ููููุฉ:
- [ุชุญููู IDEFICS](#ุชุญููู-ุงููููุฐุฌ) ู [ุชุญููู ุงูุฅุตุฏุงุฑ ุงูููู ูู ุงููููุฐุฌ](#ุงููููุฐุฌ-ุงูููู)
- ุงุณุชุฎุฏุงู IDEFICS ููุง ููู:
  - [ูุถุน ุนููุงู ููุตูุฑุฉ](#ูุถุน-ุนููุงู-ููุตูุฑุฉ)
  - [ูุถุน ุนููุงู ููุตูุฑุฉ ุจูุงุกู ุนูู ููุฌูุงุช](#ูุถุน-ุนููุงู-ููุตูุฑุฉ-ุจูุงุกู-ุนูู-ููุฌูุงุช)
  - [ุงูุชูุฌูู ุงููููู](#ุงูุชูุฌูู-ุงููููู)
  - [ุงูุฅุฌุงุจุฉ ุนูู ุงูุฃุณุฆูุฉ ุงูุจุตุฑูุฉ](#ุงูุฅุฌุงุจุฉ-ุนูู-ุงูุฃุณุฆูุฉ-ุงูุจุตุฑูุฉ)
  - [ุชุตููู ุงูุตูุฑ](#ุชุตููู-ุงูุตูุฑ)
  - [ุชูููุฏ ุงููุต ุงูููุฌู ุจุงูุตูุฑุฉ](#ุชูููุฏ-ุงููุต-ุงูููุฌู-ุจุงูุตูุฑุฉ)
- [ุชุดุบูู ุงูุงุณุชุฏูุงู ูู ูุถุน ุงูุฏูุนุฉ](#ุชุดุบูู-ุงูุงุณุชุฏูุงู-ูู-ูุถุน-ุงูุฏูุนุฉ)
- [ุชุดุบูู IDEFICS instruct ููุงุณุชุฎุฏุงูุงุช ุงููุญุงุฏุซูุฉ](#ุชุดุบูู-idefics-instruct-ููุงุณุชุฎุฏุงูุงุช-ุงููุญุงุฏุซูุฉ)

ูุจู ุงูุจุฏุกุ ุชุฃูุฏ ูู ุชุซุจูุช ุฌููุน ุงูููุชุจุงุช ุงูุถุฑูุฑูุฉ.

```bash
pip install -q bitsandbytes sentencepiece accelerate transformers
```

<Tip>
ูุชุดุบูู ุงูุฃูุซูุฉ ุงูุชุงููุฉ ุจุงุณุชุฎุฏุงู ุฅุตุฏุงุฑ ุบูุฑ ููู ูู ููุทุฉ ุชูุชูุด ุงููููุฐุฌุ ุณุชุญุชุงุฌ ุฅูู ุฐุงูุฑุฉ GPU ูุง ุชูู ุนู 20 ุฌูุฌุงุจุงูุช.
</Tip>

## ุชุญููู ุงููููุฐุฌ

ุฏุนููุง ูุจุฏุฃ ุจุชุญููู ููุทุฉ ุชูุชูุด ูุนููุงุช ุงููููุฐุฌ ุงูุจุงูุบุฉ 9 ูููุงุฑุงุช:

```py
>>> checkpoint = "HuggingFaceM4/idefics-9b"
```

ุชูุงููุง ูุซู ุงูููุงุฐุฌ ุงูุฃุฎุฑู ูู Transformersุ ููุฒูู ุชุญููู ูุนุงูุฌ ูุงููููุฐุฌ ููุณู ูู ููุทุฉ ุงูุชูุชูุด. ูุฌูุน ูุนุงูุฌ IDEFICS ุจูู [`LlamaTokenizer`] ููุนุงูุฌ ุงูุตูุฑ IDEFICS ูู ูุนุงูุฌ ูุงุญุฏ ููุงูุชูุงู ุจุฅุนุฏุงุฏ ุฅุฏุฎุงูุงุช ุงููุต ูุงูุตูุฑุฉ ูููููุฐุฌ.

```py
>>> import torch

>>> from transformers import IdeficsForVisionText2Text, AutoProcessor

>>> processor = AutoProcessor.from_pretrained(checkpoint)
```py
>>> import torch

>>> from transformers import IdeficsForVisionText2Text, AutoProcessor

>>> processor = AutoProcessor.from_pretrained(checkpoint)

>>> model = IdeficsForVisionText2Text.from_pretrained(checkpoint, torch_dtype=torch.bfloat16, device_map="auto")
```

ูุคุฏู ุชุนููู `device_map` ุฅูู `"auto"` ุฅูู ุชุญุฏูุฏ ููููุฉ ุชุญููู ูุชุฎุฒูู ุฃูุฒุงู ุงููููุฐุฌ ุจุงูุทุฑููุฉ ุงูุฃูุซุฑ ุชุญุณูููุง ุจุงููุธุฑ ุฅูู ุงูุฃุฌูุฒุฉ ุงูููุฌูุฏุฉ.

### ุงููููุฐุฌ ุงูููู

ุฅุฐุง ูุงูุช ุฐุงูุฑุฉ GPU ุนุงููุฉ ุงูุณุนุฉ ุชูุซู ูุดููุฉุ ูููููู ุชุญููู ุงูุฅุตุฏุงุฑ ุงูููู ูู ุงููููุฐุฌ. ูุชุญููู ุงููููุฐุฌ ูุงููุนุงูุฌ ุจุฏูุฉ 4 ุจุชุ ูู ุจุชูุฑูุฑ `BitsAndBytesConfig` ุฅูู ุทุฑููุฉ `from_pretrained` ูุณูุชู ุถุบุท ุงููููุฐุฌ ุฃุซูุงุก ุงูุชุญููู.

```py
>>> import torch
>>> from transformers import IdeficsForVisionText2Text, AutoProcessor, BitsAndBytesConfig

>>> quantization_config = BitsAndBytesConfig(
...     load_in_4bit=True,
...     bnb_4bit_compute_dtype=torch.float16,
... )

>>> processor = AutoProcessor.from_pretrained(checkpoint)

>>> model = IdeficsForVisionText2Text.from_pretrained(
...     checkpoint,
...     quantization_config=quantization_config,
...     device_map="auto"
... )
```

ุงูุขู ุจุนุฏ ุฃู ููุช ุจุชุญููู ุงููููุฐุฌ ุจุฅุญุฏู ุงูุทุฑู ุงูููุชุฑุญุฉุ ุฏุนูุง ููุชูู ุฅูู ุงุณุชูุดุงู ุงูููุงู ุงูุชู ููููู ุงุณุชุฎุฏุงู IDEFICS ููุง.

## ูุถุน ุนููุงู ููุตูุฑุฉ
ูุถุน ุนููุงู ููุตูุฑุฉ ูู ูููุฉ ุงูุชูุจุค ุจุนููุงู ูุตูุฑุฉ ูุนููุฉ. ุฃุญุฏ ุงูุชุทุจููุงุช ุงูุดุงุฆุนุฉ ูู ูุณุงุนุฏุฉ ุงูุฃุดุฎุงุต ุถุนุงู ุงูุจุตุฑ ุนูู ุงูุชููู ูู ูุฎุชูู ุงูููุงููุ ุนูู ุณุจูู ุงููุซุงูุ ุงุณุชูุดุงู ูุญุชูู ุงูุตูุฑุฉ ุนุจุฑ ุงูุฅูุชุฑูุช.

ูุชูุถูุญ ุงููููุฉุ ุงุญุตู ุนูู ุตูุฑุฉ ููุถุน ุนููุงู ููุงุ ุนูู ุณุจูู ุงููุซุงู:

<div class="flex justify-center">
     <img src="https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/transformers/tasks/idefics-im-captioning.jpg" alt="ุตูุฑุฉ ูุฌุฑู ูู ุณุฑูุฑ ูู ุงูุฒููุฑ"/>
</div>

ุงูุตูุฑุฉ ุจูุงุณุทุฉ [Hendo Wang](https://unsplash.com/@hendoo).

ููุจู IDEFICS ููุฌูุงุช ุงููุต ูุงูุตูุฑุฉ. ููุน ุฐููุ ููุถุน ุนููุงู ูุตูุฑุฉุ ูุง ููุฒู ุชูุฏูู ููุฌู ูุตู ุฅูู ุงููููุฐุฌุ ููุท ุงูุตูุฑุฉ ุงููุฏุฎูุฉ ุงููุนุงูุฌุฉ ูุณุจููุง. ุจุฏูู ููุฌู ูุตูุ ุณูุจุฏุฃ ุงููููุฐุฌ ูู ุฅูุดุงุก ูุต ูู ุฑูุฒ BOS (ุจุฏุงูุฉ ุงูุชุณูุณู) ูุจุงูุชุงูู ุฅูุดุงุก ุนููุงู.

ูุฅุฏุฎุงู ุตูุฑุฉ ูููููุฐุฌุ ููููู ุงุณุชุฎุฏุงู ูุงุฆู ุตูุฑุฉ (`PIL.Image`) ุฃู ุนููุงู URL ูููู ุงุณุชุฑุฏุงุฏ ุงูุตูุฑุฉ ููู.

```py
>>> prompt = [
...     "https://images.unsplash.com/photo-1583160247711-2191776b4b91?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDBzjixsfHx8fA%3D%3D&auto=format&fit=crop&w=3542&q=80",
... ]

>>> inputs = processor(prompt, return_tensors="pt").to("cuda")
>>> bad_words_ids = processor.tokenizer(["<image>", "<fake_token_around_image>"], add_special_tokens=False).input_ids

>>> generated_ids = model.generate(**inputs, max_new_tokens=10, bad_words_ids=bad_words_ids)
>>> generated_text = processor.batch_decode(generated_ids, skip_special_tokens=True)
>>> print(generated_text[0])
A puppy in a flower bed
```

<Tip>

ูู ุงูุฌูุฏ ุชุถููู `bad_words_ids` ูู ุงูููุงููุฉ ุฅูู `generate` ูุชุฌูุจ ุงูุฃุฎุทุงุก ุงููุงุดุฆุฉ ุนูุฏ ุฒูุงุฏุฉ `max_new_tokens`: ุณูุญุงูู ุงููููุฐุฌ ุฅูุดุงุก ุฑูุฒ `<image>` ุฃู `<fake_token_around_image>` ุฌุฏูุฏ ุนูุฏูุง ูุง ุชููู ููุงู ุตูุฑุฉ ููุดุฆูุง ุงููููุฐุฌ.
ููููู ุชุนูููู ุฃุซูุงุก ุงูุชููู ููุง ูู ููุถุญ ูู ูุฐุง ุงูุฏูููุ ุฃู ุชุฎุฒููู ูู `GenerationConfig` ููุง ูู ููุถุญ ูู ุฏููู [ุงุณุชุฑุงุชูุฌูุงุช ุฅูุดุงุก ุงููุต](../generation_strategies).
</Tip>

## ูุถุน ุนููุงู ููุตูุฑุฉ ุจูุงุกู ุนูู ููุฌูุงุช

ููููู ุชูุณูุน ูุทุงู ูุถุน ุนููุงู ุงูุตูุฑุฉ ุนู ุทุฑูู ุชูููุฑ ููุฌู ูุตูุ ูุงูุฐู ุณููุงุตู ุงููููุฐุฌ ุชูููุฐู ุจูุงุกู ุนูู ุงูุตูุฑุฉ. ุฏุนูุง ูุฃุฎุฐ ุตูุฑุฉ ุฃุฎุฑู ูุชูุถูุญ ุฐูู:

<div class="flex justify-center">
     <img src="https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/transformers/tasks/idefics-prompted-im-captioning.jpg" alt="ุตูุฑุฉ ูุจุฑุฌ ุฅููู ูููุงู"/>
</div>

ุงูุตูุฑุฉ ุจูุงุณุทุฉ [Denys Nevozhai](https://unsplash.com/@dnevozhai).

ูููู ุชูุฑูุฑ ููุฌูุงุช ุงููุต ูุงูุตูุฑุฉ ุฅูู ูุนุงูุฌ ุงููููุฐุฌ ููุงุฆูุฉ ูุงุญุฏุฉ ูุฅูุดุงุก ุงูุฅุฏุฎุงูุงุช ุงูููุงุณุจุฉ.
ุงูุตูุฑุฉ ุจูุงุณุทุฉ [Denys Nevozhai](https://unsplash.com/@dnevozhai).

ูููู ุชูุฑูุฑ ููุฌูุงุช ุงููุต ูุงูุตูุฑุฉ ุฅูู ูุนุงูุฌ ุงููููุฐุฌ ููุงุฆูุฉ ูุงุญุฏุฉ ูุฅูุดุงุก ุงูุฅุฏุฎุงูุงุช ุงูููุงุณุจุฉ.

```py
>>> prompt = [
...     "https://images.unsplash.com/photo-1543349689-9a4d426bee8e?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=3501&q=80",
...     "This is an image of ",
... ]

>>> inputs = processor(prompt, return_tensors="pt").to("cuda")
>>> bad_words_ids = processor.tokenizer(["<image>", "<fake_token_around_image>"], add_special_tokens=False).input_ids

>>> generated_ids = model.generate(**inputs, max_new_tokens=10, bad_words_ids=bad_words_ids)
>>> generated_text = processor.batch_decode(generated_ids, skip_special_tokens=True)
>>> print(generated_text[0])
This is an image of the Eiffel Tower in Paris, France.
```

## ุงูุชูุฌูู ุงููููู

ูู ุญูู ุฃู IDEFICS ูุธูุฑ ูุชุงุฆุฌ ููุชุงุฒุฉ ุจุฏูู ุชูุฌููุ ููุฏ ุชุชุทูุจ ูููุชู ุชูุณูููุง ูุนูููุง ููุนููุงูุ ุฃู ูุฏ ุชุฃุชู ุจูููุฏ ุฃู ูุชุทูุจุงุช ุฃุฎุฑู ุชุฒูุฏ ูู ุชุนููุฏ ุงููููุฉ. ูููู ุงุณุชุฎุฏุงู ุงูุชูุฌูู ุงููููู ูุชูููู ุงูุชุนูู ูู ุงูุณูุงู. ูู ุฎูุงู ุชูููุฑ ุฃูุซูุฉ ูู ุงูููุฌูุ ููููู ุชูุฌูู ุงููููุฐุฌ ูุชูููุฏ ูุชุงุฆุฌ ุชุญุงูู ุชูุณูู ุงูุฃูุซูุฉ ุงููุนุทุงุฉ.

ุฏุนููุง ูุณุชุฎุฏู ุตูุฑุฉ ุจุฑุฌ ุฅููู ุงูุณุงุจูุฉ ููุซุงู ูููููุฐุฌ ููุจูู ููุฌููุง ููุถุญ ูููููุฐุฌ ุฃูู ุจุงูุฅุถุงูุฉ ุฅูู ุชุนูู ูุง ูู ุงููุงุฆู ูู ุงูุตูุฑุฉุ ููุฏ ุฃูุถูุง ุงูุญุตูู ุนูู ุจุนุถ ุงููุนูููุงุช ุงููุซูุฑุฉ ููุงูุชูุงู ุนูู. ุซู ุฏุนููุง ูุฑูุ ุฅุฐุง ูุงู ุจุฅููุงููุง ุงูุญุตูู ุนูู ููุณ ุชูุณูู ุงูุงุณุชุฌุงุจุฉ ูุตูุฑุฉ ุชูุซุงู ุงูุญุฑูุฉ:

<div class="flex justify-center">
     <img src="https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/transformers/tasks/idefics-few-shot.jpg" alt="ุตูุฑุฉ ูุชูุซุงู ุงูุญุฑูุฉ"/>
</div>

ุงูุตูุฑุฉ ุจูุงุณุทุฉ [Juan Mayobre](https://unsplash.com/@jmayobres).

```py
>>> prompt = ["User:",
...            "https://images.unsplash.com/photo-1543349689-9a4d426bee8e?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=3501&q=80",
...            "Describe this image.\nAssistant: An image of the Eiffel Tower at night. Fun fact: the Eiffel Tower is the same height as an 81-storey building.\n",
...            "User:",
...            "https://images.unsplash.com/photo-1524099163253-32b7f0256868?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=3387&q=80",
...            "Describe this image.\nAssistant:"
...            ]

>>> inputs = processor(prompt, return_tensors="pt").to("cuda")
>>> bad_words_ids = processor.tokenizer(["<image>", "<fake_token_around_image>"], add_special_tokens=False).input_ids

>>> generated_ids = model.generate(**inputs, max_new_tokens=30, bad_words_ids=bad_words_ids)
>>> generated_text = processor.batch_decode(generated_ids, skip_special_tokens=True)
>>> print(generated_text[0])
User: Describe this image.
Assistant: An image of the Eiffel Tower at night. Fun fact: the Eiffel Tower is the same height as an 81-storey building. 
User: Describe this image.
Assistant: An image of the Statue of Liberty. Fun fact: the Statue of Liberty is 151 feet tall.
```

ูุงุญุธ ุฃูู ูู ูุฌุฑุฏ ูุซุงู ูุงุญุฏ (ุฃูุ 1-shot)ุ ุชุนูู ุงููููุฐุฌ ููููุฉ ุฃุฏุงุก ุงููููุฉ. ุจุงููุณุจุฉ ููููุงู ุงูุฃูุซุฑ ุชุนููุฏูุงุ ูุง ุชุชุฑุฏุฏ ูู ุงูุชุฌุฑุจุฉ ุจุนุฏุฏ ุฃูุจุฑ ูู ุงูุฃูุซูุฉ (ุนูู ุณุจูู ุงููุซุงูุ 3-shotุ 5-shotุ ุฅูุฎ).

## ุงูุฅุฌุงุจุฉ ุนูู ุงูุฃุณุฆูุฉ ุงูุจุตุฑูุฉ

ุงูุฅุฌุงุจุฉ ุนูู ุงูุฃุณุฆูุฉ ุงููุฑุฆูุฉ (VQA) ูู ูููุฉ ุงูุฅุฌุงุจุฉ ุนูู ุงูุฃุณุฆูุฉ ุงูููุชูุญุฉ ุจูุงุกู ุนูู ุตูุฑุฉ. ุนูู ุบุฑุงุฑ ูุถุน ุนููุงู ุงูุตูุฑุฉุ ูููู ุงุณุชุฎุฏุงูู ูู ุชุทุจููุงุช ุฅููุงููุฉ ุงููุตููุ ูููู ุฃูุถูุง ูู ุงูุชุนููู (ุงูุงุณุชุฏูุงู ุญูู ุงูููุงุฏ ุงููุฑุฆูุฉ)ุ ูุฎุฏูุฉ ุงูุนููุงุก (ุงูุฃุณุฆูุฉ ุญูู ุงูููุชุฌุงุช ุจูุงุกู ุนูู ุงูุตูุฑ)ุ ูุงุณุชุฑุฌุงุน ุงูุตูุฑ.

ุฏุนูุง ูุญุตู ุนูู ุตูุฑุฉ ุฌุฏูุฏุฉ ููุฐู ุงููููุฉ:
ุฏุนูุง ูุญุตู ุนูู ุตูุฑุฉ ุฌุฏูุฏุฉ ููุฐู ุงููููุฉ:

<div class="flex justify-center">
     <img src="https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/transformers/tasks/idefics-vqa.jpg" alt="ุตูุฑุฉ ูุฒูุฌูู ูุชูุงููุงู ูุฒูุฉ"/>
</div>

ุงูุตูุฑุฉ ุจูุงุณุทุฉ [Jarritos Mexican Soda](https://unsplash.com/@jarritos).

ููููู ุชูุฌูู ุงููููุฐุฌ ูู ูุถุน ุนููุงู ุงูุตูุฑุฉ ุฅูู ุงูุฅุฌุงุจุฉ ุนูู ุงูุฃุณุฆูุฉ ุงููุฑุฆูุฉ ุนู ุทุฑูู ุชูุฌููู ุจุชุนูููุงุช ููุงุณุจุฉ:

```py
>>> prompt = [
...     "Instruction: Provide an answer to the question. Use the image to answer.\n",
...     "https://images.unsplash.com/photo-1623944889288-cd147dbb517c?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=3540&q=80",
...     "Question: Where are these people and what's the weather like? Answer:"
... ]

>>> inputs = processor(prompt, return_tensors="pt").to("cuda")
>>> bad_words_ids = processor.tokenizer(["<image>", "<fake_token_around_image>"], add_special_tokens=False).input_ids

>>> generated_ids = model.generate(**inputs, max_new_tokens=20, bad_words_ids=bad_words_ids)
>>> generated_text = processor.batch_decode(generated_ids, skip_special_tokens=True)
>>> print(generated_text[0])
Instruction: Provide an answer to the question. Use the image to answer.
 Question: Where are these people and what's the weather like? Answer: They're in a park in New York City, and it's a beautiful day.
```

## ุชุตููู ุงูุตูุฑ

IDEFICS ูุงุฏุฑ ุนูู ุชุตููู ุงูุตูุฑ ุฅูู ูุฆุงุช ูุฎุชููุฉ ุฏูู ุชุฏุฑูุจ ุตุฑูุญ ุนูู ุงูุจูุงูุงุช ุงูุชู ุชุญุชูู ุนูู ุฃูุซูุฉ ููุณููุฉ ูู ุชูู ุงููุฆุงุช ุงููุญุฏุฏุฉ. ุจุงููุธุฑ ุฅูู ูุงุฆูุฉ ุงููุฆุงุช ูุงุณุชุฎุฏุงู ูุฏุฑุงุชู ูู ููู ุงูุตูุฑ ูุงููุตูุตุ ูููู ูููููุฐุฌ ุงุณุชูุชุงุฌ ุงููุฆุฉ ุงูุชู ุชูุชูู ุฅูููุง ุงูุตูุฑุฉ ุนูู ุงูุฃุฑุฌุญ.

ูููุชุฑุถ ุฃู ูุฏููุง ูุฐู ุงูุตูุฑุฉ ูุทุงููุฉ ุงูุฎุถุงุฑ:

<div class="flex justify-center">
     <img src="https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/transformers/tasks/idefics-classification.jpg" alt="ุตูุฑุฉ ูุทุงููุฉ ุงูุฎุถุงุฑ"/>
</div>

ุชุตููุฑ ููุชูุบุฑุงูู ุจูุงุณุทุฉ [ุจูุชุฑ ูููุฏุช](https://unsplash.com/@peterwendt).

ูููููุง ุชูุฌูู ุงููููุฐุฌ ูุชุตููู ุงูุตูุฑุฉ ุฅูู ุฅุญุฏู ุงููุฆุงุช ุงูุชู ูุฏููุง:

```py
>>> categories = ['animals','vegetables', 'city landscape', 'cars', 'office']
>>> prompt = [f"Instruction: Classify the following image into a single category from the following list: {categories}.\n",
...     "https://images.unsplash.com/photo-1471193945509-9ad0617afabf?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=3540&q=80",    
...     "Category: "
... ]

>>> inputs = processor(prompt, return_tensors="pt").to("cuda")
>>> bad_words_ids = processor.tokenizer(["<image>", "<fake_token_around_image>"], add_special_tokens=False).input_ids

>>> generated_ids = model.generate(**inputs, max_new_tokens=6, bad_words_ids=bad_words_ids)
>>> generated_text = processor.batch_decode(generated_ids, skip_special_tokens=True)
>>> print(generated_text[0])
Instruction: Classify the following image into a single category from the following list: ['animals', 'vegetables', 'city landscape', 'cars', 'office'].
Category: Vegetables
```

ูู ุงููุซุงู ุฃุนูุงูุ ููุฌู ุงููููุฐุฌ ูุชุตููู ุงูุตูุฑุฉ ุฅูู ูุฆุฉ ูุงุญุฏุฉุ ููุน ุฐููุ ููููู ุฃูุถูุง ุชูุฌูู ุงููููุฐุฌ ููููุงู ุจุงูุชุตููู ุงูุชุฑุชูุจู.

## ุชูููุฏ ุงููุต ุงูููุฌู ุจุงูุตูุฑ

ูุชุทุจููุงุช ุฃูุซุฑ ุฅุจุฏุงุนูุงุ ููููู ุงุณุชุฎุฏุงู ุชูููุฏ ุงููุต ุงูููุฌู ุจุงูุตูุฑ ูุชูููุฏ ูุต ุจูุงุกู ุนูู ุตูุฑุฉ. ูููู ุฃู ูููู ูุฐุง
ูููุฏูุง ูุฅูุดุงุก ุฃูุตุงู ููููุชุฌุงุช ูุงูุฅุนูุงูุงุช ููุตู ุงููุดูุฏุ ููุง ุฅูู ุฐูู.

ุฏุนููุง ููุฌู IDEFICS ููุชุงุจุฉ ูุตุฉ ุจูุงุกู ุนูู ุตูุฑุฉ ุจุณูุทุฉ ูุจุงุจ ุฃุญูุฑ:

<div class="flex justify-center">
     <img src="https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/transformers/tasks/idefics-story-generation.jpg" alt="ุตูุฑุฉ ูุจุงุจ ุฃุญูุฑ ูุน ูุฑุน ุนูู ุงูุฏุฑุฌุงุช"/>
</div>

ุชุตููุฑ ููุชูุบุฑุงูู ุจูุงุณุทุฉ [ูุฑูุฌ ุชูุฏุจูู](https://unsplash.com/@devonshiremedia).

```py
>>> prompt = ["Instruction: Use the image to write a story. \n",
...     "https://images.unsplash.com/photo-1517086822157-2b0358e7684a?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2203&q=80",
...     "Story: \n"]

>>> inputs = processor(prompt, return_tensors="pt").to("cuda")
>>> bad_words_ids = processor.tokenizer(["<image>", "<fake_token_around_image>"], add_special_tokens=False).input_ids

>>> generated_ids = model.generate(**inputs, num_beams=2, max_new_tokens=200, bad_words_ids=bad_words_ids)
>>> generated_text = processor.batch_decode(generated_ids, skip_special_tokens=True)
>>> print(generated_text[0]) 
Instruction: Use the image to write a story. 
 Story: 
Once upon a time, there was a little girl who lived in a house with a red door.  She loved her red door.  It was the prettiest door in the whole world.

One day, the little girl was playing in her yard when she noticed a man standing on her doorstep.  He was wearing a long black coat and a top hat.

The little girl ran inside and told her mother about the man.

Her mother said, โDonโt worry, honey.  Heโs just a friendly ghost.โ

The little girl wasnโt sure if she believed her mother, but she went outside anyway.

When she got to the door, the man was gone.

The next day, the little girl was playing in her yard again when she noticed the man standing on her doorstep.

He was wearing a long black coat and a top hat.

The little girl ran
```

ูุจุฏู ุฃู IDEFICS ูุงุญุธ ุงููุฑุน ุนูู ุนุชุจุฉ ุงูุจุงุจ ูุฐูุจ ุฅูู ูุตุฉ ูุฎููุฉ ูู ุนูุฏ ุงููุงูููู ุญูู ุดุจุญ.

<Tip>

ุจุงููุณุจุฉ ููููุงุชุฌ ุงูุฃุทูู ูุซู ูุฐุงุ ุณุชุณุชููุฏ ุจุดูู ูุจูุฑ ูู ุถุจุท ุงุณุชุฑุงุชูุฌูุฉ ุชูููุฏ ุงููุต. ูููู ุฃู ูุณุงุนุฏู ูุฐุง ุจุดูู ูุจูุฑ
ููููู ุชุญุณูู ุฌูุฏุฉ ุงูุฅุฎุฑุงุฌ ุงููููุฏ ุจุดูู ูุจูุฑ. ุชุญูู ูู [ุงุณุชุฑุงุชูุฌูุงุช ุชูููุฏ ุงููุต](../generation_strategies)
ููุนุฑูุฉ ุงููุฒูุฏ.
</Tip>

## ุชุดุบูู ุงูุงุณุชูุชุงุฌ ูู ูุถุน ุงูุฏูุนุฉ

ุชูุถุญ ุฌููุน ุงูุฃูุณุงู ุงูุณุงุจูุฉ IDEFICS ููุซุงู ูุงุญุฏ. ุจุทุฑููุฉ ูุดุงุจูุฉ ุฌุฏูุงุ ููููู ุชุดุบูู ุงูุงุณุชูุชุงุฌ
ุจุงููุณุจุฉ ูุฏูุนุฉ ูู ุงูุฃูุซูุฉ ุนู ุทุฑูู ุชูุฑูุฑ ูุงุฆูุฉ ูู ุงููุทุงูุจุงุช:

```py
>>> prompts = [
...     [   "https://images.unsplash.com/photo-1543349689-9a4d426bee8e?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=3501&q=80",
...         "This is an image of ",
...     ],
...     [   "https://images.unsplash.com/photo-1623944889288-cd147dbb517c?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=3540&q=80",
...         "This is an image of ",
...     ],
...     [   "https://images.unsplash.com/photo-1471193945509-9ad0617afabf?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=3540&q=80",
...         "This is an image of ",
...     ],
... ]

>>> inputs = processor(prompts, return_tensors="pt").to("cuda")
>>> bad_words_ids = processor.tokenizer(["<image>", "<fake_token_around_image>"], add_special_tokens=False).input_ids

>>> generated_ids = model.generate(**inputs, max_new_tokens=10, bad_words_ids=bad_words_ids)
>>> generated_text = processor.batch_decode(generated_ids, skip_special_tokens=True)
>>> for i,t in enumerate(generated_text):
...     print(f"{i}:\n{t}\n") 
0:
This is an image of the Eiffel Tower in Paris, France.

1:
This is an image of a couple on a picnic blanket.

2:
This is an image of a vegetable stand.
```

## IDEFICS instruct ููุงุณุชุฎุฏุงู ุงููุญุงุฏุซู

ุจุงููุณุจุฉ ูุญุงูุงุช ุงูุงุณุชุฎุฏุงู ุงููุญุงุฏุซูุฉุ ููููู ุงูุนุซูุฑ ุนูู ุฅุตุฏุงุฑุงุช ูุถุจูุทุฉ ุงูุฏูุฉ ูู ุงููููุฐุฌ ุนูู ๐ค Hub:
`HuggingFaceM4/idefics-80b-instruct` ู `HuggingFaceM4/idefics-9b-instruct`.

ูุฐู ููุงุท ุชูุชูุด ูุงุชุฌุฉ ุนู ุถุจุท ุฏููู ูููุงุฐุฌ ุงููุงุนุฏุฉ ุงูุฎุงุตุฉ ุจูุง ุนูู ูุฒูุฌ ูู ูุฌููุนุงุช ุงูุจูุงูุงุช ุงูุฎุงุถุนุฉ ููุฅุดุฑุงู ูุงูุชุนูููุงุช
ุถุจุท ุฏูููุ ููุง ูุนุฒุฒ ุงูุฃุฏุงุก ูู ุงุชุฌุงู ูุฌุฑู ุงูููุฑ ุฃุซูุงุก ุฌุนู ุงูููุงุฐุฌ ุฃูุซุฑ ูุงุจููุฉ ููุงุณุชุฎุฏุงู ูู ุฅุนุฏุงุฏุงุช ุงููุญุงุฏุซุฉ.

ุงูุงุณุชุฎุฏุงู ูุงูุชุดุบูู ููุงุณุชุฎุฏุงู ุงููุญุงุฏุซู ูุดุงุจู ุฌุฏูุง ูุงุณุชุฎุฏุงู ููุงุฐุฌ ุงููุงุนุฏุฉ:

```py
>>> import torch
>>> from transformers import IdeficsForVisionText2Text, AutoProcessor

>>> device = "cuda" if torch.cuda.is_available() else "cpu"

>>> checkpoint = "HuggingFaceM4/idefics-9b-instruct"
>>> model = IdeficsForVisionText2Text.from_pretrained(checkpoint, torch_dtype=torch.bfloat16).to(device)
>>> processor = AutoProcessor.from_pretrained(checkpoint)

>>> prompts = [
...     [
...         "User: What is in this image?",
...         "https://upload.wikimedia.org/wikipedia/commons/8/86/Id%C3%A9fix.JPG",
...         "<end_of_utterance>",

...         "\nAssistant: This picture depicts Idefix, the dog of Obelix in Asterix and Obelix. Idefix is running on the ground.<end_of_utterance>",

...         "\nUser:",
...         "https://static.wikia.nocookie.net/asterix/images/2/25/R22b.gif/revision/latest?cb=20110815073052",
...         "And who is that?<end_of_utterance>",

...         "\nAssistant:",
...     ],
... ]

>>> # --batched mode
>>> inputs = processor(prompts, add_end_of_utterance_token=False, return_tensors="pt").to(device)
>>> # --single sample mode
>>> # inputs = processor(prompts[0], return_tensors="pt").to(device)

>>> # Generation args
>>> exit_condition = processor.tokenizer("<end_of_utterance>", add_special_tokens=False).input_ids
>>> bad_words_ids = processor.tokenizer(["<image>", "<fake_token_around_image>"], add_special_tokens=False).input_ids

>>> generated_ids = model.generate(**inputs, eos_token_id=exit_condition, bad_words_ids=bad_words_ids, max_length=100)
>>> generated_text = processor.batch_decode(generated_ids, skip_special_tokens=True)
>>> for i, t in enumerate(generated_text):
...     print(f"{i}:\n{t}\n")
```